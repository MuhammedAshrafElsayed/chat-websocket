<html>

<head>

</head>

<body>
    <div id="wrapper">
        <h1>Welcome to chat service!</h1>
        <div id="chatbox">
            <button id="connectButton">Connect</button>
            <span id="status">Disconnected</span>
            <input type="text" id="userId" placeholder="Type the callee user" required />

            <ul id="messages"></ul>

            <form id="messageForm">
                <div>
                    <input type="text" id="messageInput" placeholder="Type your message here..." required />
                </div>
                <span id="error"></span>
                <button id="sendButton">Send</button>
                <button id="disconnectButton">Disconnect</button>
            </form>
        </div>
    </div>
    
</body>

<script>


    const connectButton = document.getElementById("connectButton");
    const userIdHtml = document.getElementById("userId");
    const disconnectButton = document.getElementById("disconnectButton");
    const submitButton = document.getElementById("messageForm");
    const messageInput = document.getElementById("messageInput");
    const errorSpan = document.getElementById("error");
    const statusSpan = document.getElementById("status");
    const messagesList = document.getElementById("messages");
    const messageForm = document.getElementById("messageForm");

    const user = window.location.hash.replace("#", "");
    console.log("user test", user);
    
    const wsUrl = `ws://192.168.100.53:3000/${user}`;
    // const wsUrl = "wss://echo.websocket.org";

    let socket = null;
    connectButton.addEventListener("click", (e) => {
        e.preventDefault();
        socket = new WebSocket(wsUrl);

        socket.addEventListener("open", (openEvent) => {
            console.log(`Connected to chat server at ${wsUrl}`);
            statusSpan.innerText = "Connected";
        });

        socket.addEventListener("close", (closeEvent) => {
            console.log(`Disconnected from chat server at ${wsUrl}`);
            statusSpan.innerText = "Disconnected";
            socket.close();
        });

        socket.addEventListener("error", (errorEvent) => {
            errorSpan.innerText = `error: ${errorEvent.type}`;
        });

        socket.addEventListener("message", (msgEvent) => {
            const receivedMessage = msgEvent.data;
            const messageItem = document.createElement("li");
            messageItem.textContent = `${userIdHtml.value}: ${receivedMessage}`;
            messagesList.appendChild(messageItem);
        });
    });
    disconnectButton.addEventListener("click", (e) => {
        e.preventDefault();
        socket.close();
    });

    messageForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const value = messageInput.value;
        
        // const user = window.location.hash.replace("#", "");
        const user = userIdHtml.value;
        console.log(`Sending message: ${value} to ${user}`);
       
        const message = {userId: user , content:  value}
        
        socket.send(JSON.stringify(message));
        messageInput.value = "";

        const messageItem = document.createElement("li");
        messageItem.textContent = `You: ${message.content}`;
        messagesList.appendChild(messageItem);
    });

</script>

</html>